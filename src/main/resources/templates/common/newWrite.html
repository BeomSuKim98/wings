<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìƒˆ ê¸€ ì‘ì„±</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script defer src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script defer th:src="@{/js/writeBtnController.js}"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; }
    .form-row { margin-bottom: 1rem; }
    .hint { color:#777; font-size:.9rem; }
    textarea { width:100%; height:240px; }
    .preview { border:1px solid #ddd; padding:1rem; margin-top:1rem; min-height:120px; background:#fafafa; }
    .errors { color:#c00; margin:.25rem 0 .5rem; }
    .editor-toolbar button {
  padding: .35rem .55rem; margin-right: .25rem;
  border: 1px solid #ccc; background: #fff; cursor: pointer;
  border-radius: .375rem;
}
.editor-toolbar button:hover { background:#f5f5f5; }
.editor-toolbar button:active { transform: translateY(1px); }
  </style>
</head>
<body>
<section th:fragment="content">
<h1>ìƒˆ ê¸€ ì‘ì„±</h1>

<!-- ìœ íš¨ì„± ë©”ì‹œì§€ ì „ì—­ ì¶œë ¥ -->
<!--<div th:if="${#fields.hasAnyErrors()}" class="errors">-->
<!--  ì…ë ¥ê°’ì„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.-->
<!--</div>-->

<form class="js-new-post-form" th:action="@{/posts}" th:object="${form}" method="post" id="NewWriteContentForm">
  <!-- Spring Securityë¥¼ ì“´ë‹¤ë©´ CSRF í† í° -->
  <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

  <!-- ì œëª© -->
  <div class="form-row">
    <label for="title">ì œëª©</label><br>
    <input id="title" type="text" th:field="*{title}" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
    <div class="errors" th:if="${#fields.hasErrors('title')}" th:errors="*{title}">ì œëª© ì˜¤ë¥˜</div>
  </div>

  <!-- ë³¸ë¬¸(HTML) -->
  <div class="form-row js-editor" id="newContentWriter">
    <label for="contentHtml">ë‚´ìš©</label>
    <span class="hint">(êµµê²Œ/ë¦¬ìŠ¤íŠ¸/ë§í¬, ì—…ë¡œë“œ ì´ë¯¸ì§€ë§Œ í—ˆìš©)</span><br>

    <!-- ğŸ§° íˆ´ë°” -->
    <div class="editor-toolbar js-toolbar" style="margin:.5rem 0;">
      <!-- í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ -->
      <button type="button" data-cmd="wrap" data-before="<strong>" data-after="</strong>" title="êµµê²Œ"><b>B</b></button>
      <button type="button" data-cmd="wrap" data-before="<em>"     data-after="</em>"     title="ê¸°ìš¸ì„"><i>I</i></button>
      <button type="button" data-cmd="wrap" data-before="<u>"      data-after="</u>"      title="ë°‘ì¤„"><u>U</u></button>
      <button type="button" data-cmd="wrap" data-before="<s>"      data-after="</s>"      title="ì·¨ì†Œì„ ">S</button>

      <!-- ì œëª© -->
      <button type="button" data-cmd="block" data-tag="h1" title="ì œëª©1">H1</button>
      <button type="button" data-cmd="block" data-tag="h2" title="ì œëª©2">H2</button>
      <button type="button" data-cmd="block" data-tag="h3" title="ì œëª©3">H3</button>

      <!-- ëª©ë¡ -->
      <button type="button" data-cmd="list" data-type="ul" title="ê¸€ë¨¸ë¦¬ê¸°í˜¸">â€¢ List</button>
      <button type="button" data-cmd="list" data-type="ol" title="ë²ˆí˜¸ëª©ë¡">1. List</button>

      <!-- ì¸ìš©/ì½”ë“œ -->
      <button type="button" data-cmd="block" data-tag="blockquote" title="ì¸ìš©êµ¬">&ldquo;&rdquo;</button>
      <button type="button" data-cmd="block" data-tag="pre"        title="ì½”ë“œë¸”ë¡">{ }</button>
      <button type="button" data-cmd="wrap"  data-before="<code>"  data-after="</code>"   title="ì¸ë¼ì¸ ì½”ë“œ">`code`</button>

      <!-- ì¤„ë°”ê¿ˆ/ìˆ˜í‰ì„  -->
      <button type="button" data-cmd="insert" data-html="<br/>" title="ì¤„ë°”ê¿ˆ">BR</button>
      <button type="button" data-cmd="insert" data-html="<hr/>" title="êµ¬ë¶„ì„ ">HR</button>

      <!-- ë§í¬ -->
      <button type="button" id="btn-insert-link" title="ë§í¬">ğŸ”—</button>

      <!-- ìŠ¤íƒ€ì¼(í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ë§Œ) -->
      <button type="button" id="btn-text-color"      title="ê¸€ììƒ‰">ğŸ¨</button>
      <button type="button" id="btn-bg-color"        title="ë°°ê²½ìƒ‰">ğŸ–Œï¸</button>
      <button type="button" id="btn-font-size"       title="í°íŠ¸í¬ê¸°">Aâ†•</button>

      <!-- ì´ë¯¸ì§€ ì‚½ì…(ì´ë¯¸ì§€ ì—…ë¡œë“œ input íŠ¸ë¦¬ê±°) -->
      <button type="button" id="btn-insert-image"    title="ì´ë¯¸ì§€">ğŸ–¼ï¸</button>
    </div>
    <textarea class="js-editor-textarea" id="contentHtml" th:field="*{contentHtml}" placeholder="ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
    <div class="errors" th:if="${#fields.hasErrors('contentHtml')}" th:errors="*{contentHtml}">ë³¸ë¬¸ ì˜¤ë¥˜</div>
  </div>

  <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ (JPEG/PNGë§Œ) -->
  <div class="form-row">
    <label for="imageUpload">ì´ë¯¸ì§€ ì—…ë¡œë“œ</label><br>
    <input class="js-image-upload" id="imageUpload" type="file" accept="image/jpeg,image/png">
    <div class="hint">ì—…ë¡œë“œí•˜ë©´ ë³¸ë¬¸ì— ìë™ìœ¼ë¡œ &lt;img&gt; íƒœê·¸ê°€ ì‚½ì…ë©ë‹ˆë‹¤.</div>
  </div>

  <!-- ìµëª… ì˜µì…˜ -->
  <div class="form-row">
    <label>
      <input type="checkbox" th:field="*{anonymous}"> ìµëª…ìœ¼ë¡œ ì‘ì„±
    </label>
  </div>

  <!-- ìµëª… í‘œì‹œ ì´ë¦„ -->
  <div class="form-row" id="anonRow" style="display:none;">
    <label for="anonDisplayName">ìµëª… í‘œì‹œ ì´ë¦„</label><br>
    <input id="anonDisplayName" type="text" th:field="*{anonDisplayName}" placeholder="ì˜ˆ: ë¬´ëª…ìš©ì‚¬">
    <div class="errors" th:if="${#fields.hasErrors('anonDisplayName')}" th:errors="*{anonDisplayName}">í‘œì‹œ ì´ë¦„ ì˜¤ë¥˜</div>
  </div>

  <button type="submit">ì €ì¥</button>
</form>

<!-- ë¯¸ë¦¬ë³´ê¸° -->
<h2>ë¯¸ë¦¬ë³´ê¸°</h2>
<div id="preview" class="preview"></div>
</section>
<script>
  // ë³¸ë¬¸ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°
  function refreshPreview() {
    document.getElementById('preview').innerHTML = document.getElementById('contentHtml').value;
  }
  document.getElementById('contentHtml').addEventListener('input', refreshPreview);
  refreshPreview();

  // ìµëª… ì²´í¬ ì‹œ í‘œì‹œ ì´ë¦„ ë…¸ì¶œ
  const anonCheckbox = document.getElementById('anonRow').previousElementSibling.querySelector('input[type="checkbox"]');
  function toggleAnonRow() {
    document.getElementById('anonRow').style.display = anonCheckbox.checked ? '' : 'none';
  }
  anonCheckbox.addEventListener('change', toggleAnonRow);
  toggleAnonRow();

  // ì´ë¯¸ì§€ ì—…ë¡œë“œ â†’ /api/uploads/image ë¡œ ì „ì†¡ í›„ URLì„ ë³¸ë¬¸ì— ì‚½ì…
  $('#imageUpload').on('change', function () {
    const file = this.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    $.ajax({
      url: '/api/uploads/image',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function (res) {
        const tag = `<img src="${res.url}" alt="image">`;
        const $ta = $('#contentHtml');
        $ta.val($ta.val() + ( $ta.val().trim() ? '\n' : '' ) + tag + '\n');
        $ta.trigger('input'); // ë¯¸ë¦¬ë³´ê¸° ê°±ì‹ 
        $('#imageUpload').val(''); // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
      },
      error: function (xhr) {
        alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (xhr.responseText || xhr.status));
      }
    });
  });
</script>

</body>
</html>

<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>새 글 작성</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; }
    .form-row { margin-bottom: 1rem; }
    .hint { color:#777; font-size:.9rem; }
    textarea { width:100%; height:240px; }
    .preview { border:1px solid #ddd; padding:1rem; margin-top:1rem; min-height:120px; background:#fafafa; }
    .errors { color:#c00; margin:.25rem 0 .5rem; }
  </style>
</head>
<body>
<section th:fragment="content">
<h1>새 글 작성</h1>

<!-- 유효성 메시지 전역 출력 -->
<!--<div th:if="${#fields.hasAnyErrors()}" class="errors">-->
<!--  입력값을 다시 확인해 주세요.-->
<!--</div>-->

<form th:action="@{/posts}" th:object="${form}" method="post">
  <!-- Spring Security를 쓴다면 CSRF 토큰 -->
  <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

  <!-- 제목 -->
  <div class="form-row">
    <label for="title">제목</label><br>
    <input id="title" type="text" th:field="*{title}" placeholder="제목을 입력하세요" required>
    <div class="errors" th:if="${#fields.hasErrors('title')}" th:errors="*{title}">제목 오류</div>
  </div>

  <!-- 본문(HTML) -->
  <div class="form-row">
    <label for="contentHtml">내용</label> <span class="hint">(굵게/리스트/링크, 업로드 이미지만 허용)</span><br>
    <textarea id="contentHtml" th:field="*{contentHtml}" placeholder="본문을 입력하세요" required></textarea>
    <div class="errors" th:if="${#fields.hasErrors('contentHtml')}" th:errors="*{contentHtml}">본문 오류</div>
  </div>

  <!-- 이미지 업로드 (JPEG/PNG만) -->
  <div class="form-row">
    <label for="imageUpload">이미지 업로드</label><br>
    <input id="imageUpload" type="file" accept="image/jpeg,image/png">
    <div class="hint">업로드하면 본문에 자동으로 &lt;img&gt; 태그가 삽입됩니다.</div>
  </div>

  <!-- 익명 옵션 -->
  <div class="form-row">
    <label>
      <input type="checkbox" th:field="*{anonymous}"> 익명으로 작성
    </label>
  </div>

  <!-- 익명 표시 이름 -->
  <div class="form-row" id="anonRow" style="display:none;">
    <label for="anonDisplayName">익명 표시 이름</label><br>
    <input id="anonDisplayName" type="text" th:field="*{anonDisplayName}" placeholder="예: 무명용사">
    <div class="errors" th:if="${#fields.hasErrors('anonDisplayName')}" th:errors="*{anonDisplayName}">표시 이름 오류</div>
  </div>

  <button type="submit">저장</button>
</form>

<!-- 미리보기 -->
<h2>미리보기</h2>
<div id="preview" class="preview"></div>
</section>
<script>
  // 본문 실시간 미리보기
  function refreshPreview() {
    document.getElementById('preview').innerHTML = document.getElementById('contentHtml').value;
  }
  document.getElementById('contentHtml').addEventListener('input', refreshPreview);
  refreshPreview();

  // 익명 체크 시 표시 이름 노출
  const anonCheckbox = document.getElementById('anonRow').previousElementSibling.querySelector('input[type="checkbox"]');
  function toggleAnonRow() {
    document.getElementById('anonRow').style.display = anonCheckbox.checked ? '' : 'none';
  }
  anonCheckbox.addEventListener('change', toggleAnonRow);
  toggleAnonRow();

  // 이미지 업로드 → /api/uploads/image 로 전송 후 URL을 본문에 삽입
  $('#imageUpload').on('change', function () {
    const file = this.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    $.ajax({
      url: '/api/uploads/image',
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function (res) {
        const tag = `<img src="${res.url}" alt="image">`;
        const $ta = $('#contentHtml');
        $ta.val($ta.val() + ( $ta.val().trim() ? '\n' : '' ) + tag + '\n');
        $ta.trigger('input'); // 미리보기 갱신
        $('#imageUpload').val(''); // 파일 입력 초기화
      },
      error: function (xhr) {
        alert('이미지 업로드 실패: ' + (xhr.responseText || xhr.status));
      }
    });
  });
</script>

</body>
</html>
